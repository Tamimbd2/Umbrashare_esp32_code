#include <WiFi.h>
#include <Firebase_ESP_Client.h>
#include <DFRobotDFPlayerMini.h>

// WiFi credentials
#define WIFI_SSID "Alamin"
#define WIFI_PASSWORD "01788392063"

// Firebase configuration
#define API_KEY "AIzaSyBntis9XQeLCtPA5vDCr30XenhGIAPO-5c"
#define DATABASE_URL "https://ledproject-esp-default-rtdb.firebaseio.com/"

// Firebase objects
FirebaseData fbdo;
FirebaseAuth auth;
FirebaseConfig config;

// DFPlayer Mini
#include <HardwareSerial.h>
HardwareSerial mySerial(2); // Use UART2
DFRobotDFPlayerMini player;

// Pin configuration
#define RELAY_PIN 25        // Relay control pin
#define RED_LED_PIN 26      // Lock indicator
#define GREEN_LED_PIN 27    // Unlock indicator
#define IR_SENSOR_PIN 33    // IR sensor
#define RX_PIN 35           // DFPlayer RX
#define TX_PIN 32           // DFPlayer TX

// Variables
bool relayState = false;    // false = locked, true = unlocked
unsigned long relayOnTime = 0;
const unsigned long AUTO_LOCK_DELAY = 12000; // 12 seconds

void setup() {
  Serial.begin(115200);
  mySerial.begin(9600, SERIAL_8N1, RX_PIN, TX_PIN);

  pinMode(RELAY_PIN, OUTPUT);
  pinMode(RED_LED_PIN, OUTPUT);
  pinMode(GREEN_LED_PIN, OUTPUT);
  pinMode(IR_SENSOR_PIN, INPUT);

  digitalWrite(RELAY_PIN, LOW); // Initially locked
  digitalWrite(RED_LED_PIN, HIGH);
  digitalWrite(GREEN_LED_PIN, LOW);

  Serial.println("Connecting to WiFi...");
  WiFi.begin(WIFI_SSID, WIFI_PASSWORD);
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println("\nâœ… WiFi Connected!");

  // Initialize DFPlayer
  if (player.begin(mySerial)) {
    Serial.println("ðŸŽµ DFPlayer connected successfully!");
    player.volume(25);
    player.play(1); // Play 001 sound on WiFi connected
  } else {
    Serial.println("âŒ DFPlayer connection failed!");
  }

  // Firebase config
  config.api_key = API_KEY;
  config.database_url = DATABASE_URL;

  Serial.println("â³ Firebase signing in...");
  if (Firebase.signUp(&config, &auth, "", "")) {
    Serial.println("âœ… Firebase Sign-In Successful!");
  } else {
    Serial.printf("âŒ Firebase Sign-In Failed: %s\n", config.signer.signupError.message.c_str());
  }

  Firebase.begin(&config, &auth);
  Firebase.reconnectWiFi(true);
  delay(2000);
}

void loop() {
  if (Firebase.ready()) {
    // âœ… Get Relay command from Firebase
    if (Firebase.RTDB.getInt(&fbdo, "/relay_status")) {
      int relayCmd = fbdo.intData();
      if (relayCmd == 1 && !relayState) {
        unlockUmbrella();
      } else if (relayCmd == 0 && relayState) {
        lockUmbrella();
      }
    }

    // âœ… Check IR sensor and update Firebase
    int irStatus = digitalRead(IR_SENSOR_PIN);
    String umbrellaStatus = (irStatus == HIGH) ? "empty" : "available";
    Firebase.RTDB.setString(&fbdo, "/ir_sensor_status", umbrellaStatus);
  }

  // âœ… Auto-lock after 12 seconds
  if (relayState && (millis() - relayOnTime >= AUTO_LOCK_DELAY)) {
    lockUmbrella();
  }

  delay(500);
}

// ðŸ”“ Unlock Umbrella Function
void unlockUmbrella() {
  relayState = true;
  relayOnTime = millis();

  digitalWrite(RELAY_PIN, HIGH);   // Relay ON
  digitalWrite(GREEN_LED_PIN, HIGH);
  digitalWrite(RED_LED_PIN, LOW);
  Serial.println("ðŸ”“ Umbrella Unlocked!");

  Firebase.RTDB.setInt(&fbdo, "/relay_status", 1);
  Firebase.RTDB.setString(&fbdo, "/system_status", "Unlocked");

  player.play(2); // Play sound 002
}

// ðŸ”’ Lock Umbrella Function
void lockUmbrella() {
  relayState = false;

  digitalWrite(RELAY_PIN, LOW);    // Relay OFF
  digitalWrite(RED_LED_PIN, HIGH);
  digitalWrite(GREEN_LED_PIN, LOW);
  Serial.println("ðŸ”’ Umbrella Locked!");

  Firebase.RTDB.setInt(&fbdo, "/relay_status", 0);
  Firebase.RTDB.setString(&fbdo, "/system_status", "Locked");

  player.play(3); // Play sound 003
}
